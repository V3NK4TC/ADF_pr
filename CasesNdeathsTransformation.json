{
    "name": "CasesNdeathsTransformation",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "name": "ECDCcasesNdeathsSource"
                },
                {
                    "name": "CountryCodeLookupSource"
                }
            ],
            "sinks": [
                {
                    "name": "CasesNdeathsTransformed"
                }
            ],
            "transformations": [
                {
                    "name": "FilterAsiaData"
                },
                {
                    "name": "LookupCountryCode"
                },
                {
                    "name": "SelectOnlyReFields"
                },
                {
                    "name": "PivotOnIndicator"
                }
            ],
            "script": "source(output(\n\t\tcountry as string,\n\t\tcountry_code as string,\n\t\tcontinent as string,\n\t\tpopulation as integer,\n\t\tindicator as string,\n\t\tdaily_count as integer,\n\t\tdate as date,\n\t\trate_14_day as double,\n\t\tsource as string\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false) ~> ECDCcasesNdeathsSource\nsource(output(\n\t\tcountry as string,\n\t\tcountry_code_2_digit as string,\n\t\tcountry_code_3_digit as string,\n\t\tcontinent as string,\n\t\tpopulation as integer\n\t),\n\tallowSchemaDrift: false,\n\tvalidateSchema: false) ~> CountryCodeLookupSource\nECDCcasesNdeathsSource filter(continent == 'Asia' && not(isNull(country_code))) ~> FilterAsiaData\nFilterAsiaData, CountryCodeLookupSource lookup(country_code == country_code_3_digit,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> LookupCountryCode\nLookupCountryCode select(mapColumn(\n\t\tcountry = ECDCcasesNdeathsSource@country,\n\t\tcountry_code_2_digit,\n\t\tcountry_code_3_digit,\n\t\tpopulation = ECDCcasesNdeathsSource@population,\n\t\tindicator,\n\t\tdaily_count,\n\t\treported_date = date,\n\t\tsource\n\t),\n\tskipDuplicateMapInputs: false,\n\tskipDuplicateMapOutputs: false) ~> SelectOnlyReFields\nSelectOnlyReFields pivot(groupBy(country,\n\t\tcountry_code_2_digit,\n\t\tcountry_code_3_digit,\n\t\tpopulation,\n\t\treported_date,\n\t\tsource),\n\tpivotBy(indicator, ['confirmed cases', 'deaths']),\n\tCount = sum(daily_count),\n\tcolumnNaming: '$N_$V',\n\tlateral: false) ~> PivotOnIndicator\nPivotOnIndicator sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\ttruncate: true,\n\tmapColumn(\n\t\tcountry,\n\t\tcountry_code_2_digit,\n\t\tcountry_code_3_digit,\n\t\tpopulation,\n\t\treported_date,\n\t\tsource,\n\t\t{Count_confirmed cases},\n\t\tCount_deaths\n\t),\n\tpreCommands: [],\n\tpostCommands: []) ~> CasesNdeathsTransformed"
        }
    }
}